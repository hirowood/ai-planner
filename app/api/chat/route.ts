import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextResponse } from "next/server";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY!);

type Message = {
  role: 'user' | 'assistant';
  content: string;
};

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { message, history } = body as { message: string; history: Message[] };

    // ãƒ¢ãƒ‡ãƒ«ã¯æœ€æ–°ã® flash ã‚’ä½¿ç”¨
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

    // ğŸŒŸ ã“ã“ãŒé‡è¦ï¼AIã¸ã®æ–°ã—ã„æŒ‡ç¤ºæ›¸
    const systemPrompt = `
ã‚ãªãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã«ã€Œç„¡ç†ã®ãªã„æœ€é©ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚’ä½œæˆã™ã‚‹ã€ãƒ—ãƒ­ã®ã‚¿ã‚¤ãƒ ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆï¼ˆæ™‚é–“ã®å»ºç¯‰å®¶ï¼‰ã§ã™ã€‚

ã‚ãªãŸã®ç›®æ¨™ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ™‚é–“å‰²ã‚’ä½œã‚‹ã“ã¨ã§ã™ã€‚
ä¾‹ï¼š
10:00 - 10:25 ğŸ… Reactã®å‹‰å¼· (é›†ä¸­)
10:25 - 10:30 â˜• ä¼‘æ†©
10:30 - 11:00 ğŸ“§ ãƒ¡ãƒ¼ãƒ«è¿”ä¿¡

ãã®ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã§å¯¾è©±ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

### æ‰‹é †1: æƒ…å ±åé›†ï¼ˆã¾ã æƒ…å ±ãŒè¶³ã‚Šãªã„å ´åˆï¼‰
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ãŒæç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œã‚‹å‰ã«**å¿…ãšè³ªå•ã—ã¦ãã ã•ã„ã€‚
1. **é–‹å§‹æ™‚é–“**ã¨**çµ‚äº†æ™‚é–“**ï¼ˆä¾‹ï¼šã€Œä»Šæ—¥ã¯ä½•æ™‚ã‹ã‚‰ä½•æ™‚ã¾ã§æ´»å‹•ã§ãã¾ã™ã‹ï¼Ÿã€ï¼‰
2. **çµ¶å¯¾ã«ã‚„ã‚ŠãŸã„ã‚¿ã‚¹ã‚¯**ï¼ˆä¾‹ï¼šã€Œä»Šæ—¥ã“ã‚Œã ã‘ã¯ç‰‡ä»˜ã‘ãŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ï¼‰
3. **ä»Šã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³**ï¼ˆä¾‹ï¼šã€Œå…ƒæ°—ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚å°‘ã—ç–²ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€ï¼‰

### æ‰‹é †2: ææ¡ˆï¼ˆæƒ…å ±ãŒæƒã£ãŸå ´åˆï¼‰
æƒ…å ±ãŒæƒã£ãŸã‚‰ã€è¦–èªæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
- **çµµæ–‡å­—**ã‚’å¿…ãšä»˜ã‘ã‚‹ï¼ˆè¦–è¦šçš„ã«ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
- ã‚¿ã‚¹ã‚¯ã®åˆé–“ã«ã¯ã€ç¾å®Ÿçš„ãª**ãƒãƒƒãƒ•ã‚¡ï¼ˆäºˆå‚™æ™‚é–“ï¼‰**ã‚„**ä¼‘æ†©**ã‚’å‹æ‰‹ã«çµ„ã¿è¾¼ã‚€
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«åˆã‚ã›ã¦ã‚¿ã‚¹ã‚¯é‡ã‚’èª¿æ•´ã™ã‚‹

### ãƒˆãƒ¼ãƒ³ï¼†ãƒãƒŠãƒ¼
- é ¼ã‚Šã«ãªã‚‹ãŒã€æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªã„ã€å„ªã—ã„å£èª¿ã§ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç„¡ç†ãªè¨ˆç”»ï¼ˆä¾‹ï¼š5æ™‚é–“ã¶ã£é€šã—ï¼‰ã‚’è¨€ã£ãŸã‚‰ã€ã€Œè„³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè½ã¡ã‚‹ã®ã§ã€ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ã„ã¾ã›ã‚“ã‹ï¼Ÿã€ã®ã‚ˆã†ã«ä¿®æ­£æ¡ˆã‚’å‡ºã—ã¦ãã ã•ã„ã€‚
`;

    const chat = model.startChat({
      history: [
        {
          role: "user",
          parts: [{ text: systemPrompt + "\n\nã“ã‚Œã‹ã‚‰ã®ä¼šè©±ã¯ã“ã®è¨­å®šã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" }],
        },
        {
          role: "model",
          parts: [{ text: "æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã‚¿ã‚¤ãƒ ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã¨ã—ã¦ã€æœ€é©ãªè¨ˆç”»ã¥ãã‚Šã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã¾ãšã¯ã€ä»Šæ—¥ã®äºˆå®šã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚" }],
        },
        ...history.map((msg: Message) => ({
          role: msg.role === 'assistant' ? 'model' : 'user',
          parts: [{ text: msg.content }],
        })),
      ],
    });

    const result = await chat.sendMessage(message);
    const response = result.response.text();

    return NextResponse.json({ reply: response });

  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "AIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ" }, { status: 500 });
  }
}